<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>node_modules/websocket-extensions/README · Underbase</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;websocket-extensions-build-status-https-securetravis-ciorg-faye-websocket-extensions-nodesvg-http-travis-ciorg-faye-websocket-extensions-node&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#websocket-extensions-build-status-https-securetravis-ciorg-faye-websocket-extensions-nodesvg-http-travis-ciorg-faye-websocket-extensions-node&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;websocket-extensions &lt;a href=&quot;http://travis-ci.org/faye/websocket-extensions-node&quot;&gt;&lt;img src=&quot;https://secure.travis-ci.org/faye/websocket-extensions-node.svg&quot; alt=&quot;Build status&quot;&gt;&lt;/a&gt;&lt;/h1&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="node_modules/websocket-extensions/README · Underbase"/><meta property="og:type" content="website"/><meta property="og:url" content="https://sundowndev.github.io/underbase/"/><meta property="og:description" content="&lt;h1&gt;&lt;a class=&quot;anchor&quot; aria-hidden=&quot;true&quot; id=&quot;websocket-extensions-build-status-https-securetravis-ciorg-faye-websocket-extensions-nodesvg-http-travis-ciorg-faye-websocket-extensions-node&quot;&gt;&lt;/a&gt;&lt;a href=&quot;#websocket-extensions-build-status-https-securetravis-ciorg-faye-websocket-extensions-nodesvg-http-travis-ciorg-faye-websocket-extensions-node&quot; aria-hidden=&quot;true&quot; class=&quot;hash-link&quot;&gt;&lt;svg class=&quot;hash-link-icon&quot; aria-hidden=&quot;true&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;websocket-extensions &lt;a href=&quot;http://travis-ci.org/faye/websocket-extensions-node&quot;&gt;&lt;img src=&quot;https://secure.travis-ci.org/faye/websocket-extensions-node.svg&quot; alt=&quot;Build status&quot;&gt;&lt;/a&gt;&lt;/h1&gt;
"/><meta property="og:image" content="https://sundowndev.github.io/underbase/img/undraw_online.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://sundowndev.github.io/underbase/img/undraw_tweetstorm.svg"/><link rel="shortcut icon" href="/underbase/img/logo.svg"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://sundowndev.github.io/underbase/blog/atom.xml" title="Underbase Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://sundowndev.github.io/underbase/blog/feed.xml" title="Underbase Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/underbase/js/scrollSpy.js"></script><link rel="stylesheet" href="/underbase/css/main.css"/><script src="/underbase/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/underbase/"><img class="logo" src="/underbase/img/logo.svg" alt="Underbase"/><h2 class="headerTitleWithLogo">Underbase</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/underbase/docs/installation" target="_self">Guides</a></li><li class=""><a href="/underbase/docs/api" target="_self">API</a></li><li class=""><a href="/underbase/blog/" target="_self">Release notes</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">node_modules/websocket-extensions/README</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="websocket-extensions-build-status-https-securetravis-ciorg-faye-websocket-extensions-nodesvg-http-travis-ciorg-faye-websocket-extensions-node"></a><a href="#websocket-extensions-build-status-https-securetravis-ciorg-faye-websocket-extensions-nodesvg-http-travis-ciorg-faye-websocket-extensions-node" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>websocket-extensions <a href="http://travis-ci.org/faye/websocket-extensions-node"><img src="https://secure.travis-ci.org/faye/websocket-extensions-node.svg" alt="Build status"></a></h1>
<p>A minimal framework that supports the implementation of WebSocket extensions in
a way that's decoupled from the main protocol. This library aims to allow a
WebSocket extension to be written and used with any protocol library, by
defining abstract representations of frames and messages that allow modules to
co-operate.</p>
<p><code>websocket-extensions</code> provides a container for registering extension plugins,
and provides all the functions required to negotiate which extensions to use
during a session via the <code>Sec-WebSocket-Extensions</code> header. By implementing the
APIs defined in this document, an extension may be used by any WebSocket library
based on this framework.</p>
<h2><a class="anchor" aria-hidden="true" id="installation"></a><a href="#installation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Installation</h2>
<pre><code class="hljs">$ npm <span class="hljs-keyword">install </span>websocket-<span class="hljs-keyword">extensions
</span></code></pre>
<h2><a class="anchor" aria-hidden="true" id="usage"></a><a href="#usage" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Usage</h2>
<p>There are two main audiences for this library: authors implementing the
WebSocket protocol, and authors implementing extensions. End users of a
WebSocket library or an extension should be able to use any extension by passing
it as an argument to their chosen protocol library, without needing to know how
either of them work, or how the <code>websocket-extensions</code> framework operates.</p>
<p>The library is designed with the aim that any protocol implementation and any
extension can be used together, so long as they support the same abstract
representation of frames and messages.</p>
<h3><a class="anchor" aria-hidden="true" id="data-types"></a><a href="#data-types" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Data types</h3>
<p>The APIs provided by the framework rely on two data types; extensions will
expect to be given data and to be able to return data in these formats:</p>
<h4><a class="anchor" aria-hidden="true" id="frame"></a><a href="#frame" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><em>Frame</em></h4>
<p><em>Frame</em> is a structure representing a single WebSocket frame of any type. Frames
are simple objects that must have at least the following properties, which
represent the data encoded in the frame:</p>
<table>
<thead>
<tr><th>property</th><th>description</th></tr>
</thead>
<tbody>
<tr><td><code>final</code></td><td><code>true</code> if the <code>FIN</code> bit is set, <code>false</code> otherwise</td></tr>
<tr><td><code>rsv1</code></td><td><code>true</code> if the <code>RSV1</code> bit is set, <code>false</code> otherwise</td></tr>
<tr><td><code>rsv2</code></td><td><code>true</code> if the <code>RSV2</code> bit is set, <code>false</code> otherwise</td></tr>
<tr><td><code>rsv3</code></td><td><code>true</code> if the <code>RSV3</code> bit is set, <code>false</code> otherwise</td></tr>
<tr><td><code>opcode</code></td><td>the numeric opcode (<code>0</code>, <code>1</code>, <code>2</code>, <code>8</code>, <code>9</code>, or <code>10</code>) of the frame</td></tr>
<tr><td><code>masked</code></td><td><code>true</code> if the <code>MASK</code> bit is set, <code>false</code> otherwise</td></tr>
<tr><td><code>maskingKey</code></td><td>a 4-byte <code>Buffer</code> if <code>masked</code> is <code>true</code>, otherwise <code>null</code></td></tr>
<tr><td><code>payload</code></td><td>a <code>Buffer</code> containing the (unmasked) application data</td></tr>
</tbody>
</table>
<h4><a class="anchor" aria-hidden="true" id="message"></a><a href="#message" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><em>Message</em></h4>
<p>A <em>Message</em> represents a complete application message, which can be formed from
text, binary and continuation frames. It has the following properties:</p>
<table>
<thead>
<tr><th>property</th><th>description</th></tr>
</thead>
<tbody>
<tr><td><code>rsv1</code></td><td><code>true</code> if the first frame of the message has the <code>RSV1</code> bit set</td></tr>
<tr><td><code>rsv2</code></td><td><code>true</code> if the first frame of the message has the <code>RSV2</code> bit set</td></tr>
<tr><td><code>rsv3</code></td><td><code>true</code> if the first frame of the message has the <code>RSV3</code> bit set</td></tr>
<tr><td><code>opcode</code></td><td>the numeric opcode (<code>1</code> or <code>2</code>) of the first frame of the message</td></tr>
<tr><td><code>data</code></td><td>the concatenation of all the frame payloads in the message</td></tr>
</tbody>
</table>
<h3><a class="anchor" aria-hidden="true" id="for-driver-authors"></a><a href="#for-driver-authors" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>For driver authors</h3>
<p>A driver author is someone implementing the WebSocket protocol proper, and who
wishes end users to be able to use WebSocket extensions with their library.</p>
<p>At the start of a WebSocket session, on both the client and the server side,
they should begin by creating an extension container and adding whichever
extensions they want to use.</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">var</span> Extensions = <span class="hljs-built_in">require</span>(<span class="hljs-string">'websocket-extensions'</span>),
    deflate    = <span class="hljs-built_in">require</span>(<span class="hljs-string">'permessage-deflate'</span>);

<span class="hljs-keyword">var</span> exts = <span class="hljs-keyword">new</span> Extensions();
exts.add(deflate);
</code></pre>
<p>In the following examples, <code>exts</code> refers to this <code>Extensions</code> instance.</p>
<h4><a class="anchor" aria-hidden="true" id="client-sessions"></a><a href="#client-sessions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Client sessions</h4>
<p>Clients will use the methods <code>generateOffer()</code> and <code>activate(header)</code>.</p>
<p>As part of the handshake process, the client must send a
<code>Sec-WebSocket-Extensions</code> header to advertise that it supports the registered
extensions. This header should be generated using:</p>
<pre><code class="hljs css language-js">request.headers[<span class="hljs-string">'sec-websocket-extensions'</span>] = exts.generateOffer();
</code></pre>
<p>This returns a string, for example <code>&quot;permessage-deflate; client_max_window_bits&quot;</code>, that represents all the extensions the client is
offering to use, and their parameters. This string may contain multiple offers
for the same extension.</p>
<p>When the client receives the handshake response from the server, it should pass
the incoming <code>Sec-WebSocket-Extensions</code> header in to <code>exts</code> to activate the
extensions the server has accepted:</p>
<pre><code class="hljs css language-js">exts.activate(response.headers[<span class="hljs-string">'sec-websocket-extensions'</span>]);
</code></pre>
<p>If the server has sent any extension responses that the client does not
recognize, or are in conflict with one another for use of RSV bits, or that use
invalid parameters for the named extensions, then <code>exts.activate()</code> will
<code>throw</code>. In this event, the client driver should fail the connection with
closing code <code>1010</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="server-sessions"></a><a href="#server-sessions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Server sessions</h4>
<p>Servers will use the method <code>generateResponse(header)</code>.</p>
<p>A server session needs to generate a <code>Sec-WebSocket-Extensions</code> header to send
in its handshake response:</p>
<pre><code class="hljs css language-js"><span class="hljs-keyword">var</span> clientOffer = request.headers[<span class="hljs-string">'sec-websocket-extensions'</span>],
    extResponse = exts.generateResponse(clientOffer);

response.headers[<span class="hljs-string">'sec-websocket-extensions'</span>] = extResponse;
</code></pre>
<p>Calling <code>exts.generateResponse(header)</code> activates those extensions the client
has asked to use, if they are registered, asks each extension for a set of
response parameters, and returns a string containing the response parameters for
all accepted extensions.</p>
<h4><a class="anchor" aria-hidden="true" id="in-both-directions"></a><a href="#in-both-directions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>In both directions</h4>
<p>Both clients and servers will use the methods <code>validFrameRsv(frame)</code>,
<code>processIncomingMessage(message)</code> and <code>processOutgoingMessage(message)</code>.</p>
<p>The WebSocket protocol requires that frames do not have any of the <code>RSV</code> bits
set unless there is an extension in use that allows otherwise. When processing
an incoming frame, sessions should pass a <em>Frame</em> object to:</p>
<pre><code class="hljs css language-js">exts.validFrameRsv(frame)
</code></pre>
<p>If this method returns <code>false</code>, the session should fail the WebSocket connection
with closing code <code>1002</code>.</p>
<p>To pass incoming messages through the extension stack, a session should
construct a <em>Message</em> object according to the above datatype definitions, and
call:</p>
<pre><code class="hljs css language-js">exts.processIncomingMessage(message, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, msg</span>) </span>{
  <span class="hljs-comment">// hand the message off to the application</span>
});
</code></pre>
<p>If any extensions fail to process the message, then the callback will yield an
error and the session should fail the WebSocket connection with closing code
<code>1010</code>. If <code>error</code> is <code>null</code>, then <code>msg</code> should be passed on to the application.</p>
<p>To pass outgoing messages through the extension stack, a session should
construct a <em>Message</em> as before, and call:</p>
<pre><code class="hljs css language-js">exts.processOutgoingMessage(message, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, msg</span>) </span>{
  <span class="hljs-comment">// write message to the transport</span>
});
</code></pre>
<p>If any extensions fail to process the message, then the callback will yield an
error and the session should fail the WebSocket connection with closing code
<code>1010</code>. If <code>error</code> is <code>null</code>, then <code>message</code> should be converted into frames
(with the message's <code>rsv1</code>, <code>rsv2</code>, <code>rsv3</code> and <code>opcode</code> set on the first frame)
and written to the transport.</p>
<p>At the end of the WebSocket session (either when the protocol is explicitly
ended or the transport connection disconnects), the driver should call:</p>
<pre><code class="hljs css language-js">exts.close(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{})
</code></pre>
<p>The callback is invoked when all extensions have finished processing any
messages in the pipeline and it's safe to close the socket.</p>
<h3><a class="anchor" aria-hidden="true" id="for-extension-authors"></a><a href="#for-extension-authors" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>For extension authors</h3>
<p>An extension author is someone implementing an extension that transforms
WebSocket messages passing between the client and server. They would like to
implement their extension once and have it work with any protocol library.</p>
<p>Extension authors will not install <code>websocket-extensions</code> or call it directly.
Instead, they should implement the following API to allow their extension to
plug into the <code>websocket-extensions</code> framework.</p>
<p>An <code>Extension</code> is any object that has the following properties:</p>
<table>
<thead>
<tr><th>property</th><th>description</th></tr>
</thead>
<tbody>
<tr><td><code>name</code></td><td>a string containing the name of the extension as used in negotiation headers</td></tr>
<tr><td><code>type</code></td><td>a string, must be <code>&quot;permessage&quot;</code></td></tr>
<tr><td><code>rsv1</code></td><td>either <code>true</code> if the extension uses the RSV1 bit, <code>false</code> otherwise</td></tr>
<tr><td><code>rsv2</code></td><td>either <code>true</code> if the extension uses the RSV2 bit, <code>false</code> otherwise</td></tr>
<tr><td><code>rsv3</code></td><td>either <code>true</code> if the extension uses the RSV3 bit, <code>false</code> otherwise</td></tr>
</tbody>
</table>
<p>It must also implement the following methods:</p>
<pre><code class="hljs css language-js">ext.createClientSession()
</code></pre>
<p>This returns a <em>ClientSession</em>, whose interface is defined below.</p>
<pre><code class="hljs css language-js">ext.createServerSession(offers)
</code></pre>
<p>This takes an array of offer params and returns a <em>ServerSession</em>, whose
interface is defined below. For example, if the client handshake contains the
offer header:</p>
<pre><code class="hljs">Sec-WebSocket-Extensions: permessage-deflate; server_no_context_takeover; <span class="hljs-attribute">server_max_window_bits</span>=8, \
                          permessage-deflate; <span class="hljs-attribute">server_max_window_bits</span>=15
</code></pre>
<p>then the <code>permessage-deflate</code> extension will receive the call:</p>
<pre><code class="hljs css language-js">ext.createServerSession([
  {<span class="hljs-attr">server_no_context_takeover</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">server_max_window_bits</span>: <span class="hljs-number">8</span>},
  {<span class="hljs-attr">server_max_window_bits</span>: <span class="hljs-number">15</span>}
]);
</code></pre>
<p>The extension must decide which set of parameters it wants to accept, if any,
and return a <em>ServerSession</em> if it wants to accept the parameters and <code>null</code>
otherwise.</p>
<h4><a class="anchor" aria-hidden="true" id="clientsession"></a><a href="#clientsession" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><em>ClientSession</em></h4>
<p>A <em>ClientSession</em> is the type returned by <code>ext.createClientSession()</code>. It must
implement the following methods, as well as the <em>Session</em> API listed below.</p>
<pre><code class="hljs css language-js">clientSession.generateOffer()
<span class="hljs-comment">// e.g.  -&gt; [</span>
<span class="hljs-comment">//            {server_no_context_takeover: true, server_max_window_bits: 8},</span>
<span class="hljs-comment">//            {server_max_window_bits: 15}</span>
<span class="hljs-comment">//          ]</span>
</code></pre>
<p>This must return a set of parameters to include in the client's
<code>Sec-WebSocket-Extensions</code> offer header. If the session wants to offer multiple
configurations, it can return an array of sets of parameters as shown above.</p>
<pre><code class="hljs css language-js">clientSession.activate(params) <span class="hljs-comment">// -&gt; true</span>
</code></pre>
<p>This must take a single set of parameters from the server's handshake response
and use them to configure the client session. If the client accepts the given
parameters, then this method must return <code>true</code>. If it returns any other value,
the framework will interpret this as the client rejecting the response, and will
<code>throw</code>.</p>
<h4><a class="anchor" aria-hidden="true" id="serversession"></a><a href="#serversession" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><em>ServerSession</em></h4>
<p>A <em>ServerSession</em> is the type returned by <code>ext.createServerSession(offers)</code>. It
must implement the following methods, as well as the <em>Session</em> API listed below.</p>
<pre><code class="hljs css language-js">serverSession.generateResponse()
<span class="hljs-comment">// e.g.  -&gt; {server_max_window_bits: 8}</span>
</code></pre>
<p>This returns the set of parameters the server session wants to send in its
<code>Sec-WebSocket-Extensions</code> response header. Only one set of parameters is
returned to the client per extension. Server sessions that would confict on
their use of RSV bits are not activated.</p>
<h4><a class="anchor" aria-hidden="true" id="session"></a><a href="#session" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a><em>Session</em></h4>
<p>The <em>Session</em> API must be implemented by both client and server sessions. It
contains two methods, <code>processIncomingMessage(message)</code> and
<code>processOutgoingMessage(message)</code>.</p>
<pre><code class="hljs css language-js">session.processIncomingMessage(message, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, msg</span>) </span>{ ... })
</code></pre>
<p>The session must implement this method to take an incoming <em>Message</em> as defined
above, transform it in any way it needs, then return it via the callback. If
there is an error processing the message, this method should yield an error as
the first argument.</p>
<pre><code class="hljs css language-js">session.processOutgoingMessage(message, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">error, msg</span>) </span>{ ... })
</code></pre>
<p>The session must implement this method to take an outgoing <em>Message</em> as defined
above, transform it in any way it needs, then return it via the callback. If
there is an error processing the message, this method should yield an error as
the first argument.</p>
<p>Note that both <code>processIncomingMessage()</code> and <code>processOutgoingMessage()</code> can
perform their logic asynchronously, are allowed to process multiple messages
concurrently, and are not required to complete working on messages in the same
order the messages arrive. <code>websocket-extensions</code> will reorder messages as your
extension emits them and will make sure every extension is given messages in the
order they arrive from the driver. This allows extensions to maintain state that
depends on the messages' wire order, for example keeping a DEFLATE compression
context between messages.</p>
<pre><code class="hljs css language-js">session.close()
</code></pre>
<p>The framework will call this method when the WebSocket session ends, allowing
the session to release any resources it's using.</p>
<h2><a class="anchor" aria-hidden="true" id="examples"></a><a href="#examples" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Examples</h2>
<ul>
<li>Consumer: <a href="https://github.com/faye/websocket-driver-node">websocket-driver</a></li>
<li>Provider: <a href="https://github.com/faye/permessage-deflate-node">permessage-deflate</a></li>
</ul>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#installation">Installation</a></li><li><a href="#usage">Usage</a><ul class="toc-headings"><li><a href="#data-types">Data types</a></li><li><a href="#for-driver-authors">For driver authors</a></li><li><a href="#for-extension-authors">For extension authors</a></li></ul></li><li><a href="#examples">Examples</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/underbase/" class="nav-home"><img src="/underbase/img/logo.svg" alt="Underbase" width="66" height="58"/></a><div><h5>Docs</h5><a href="/underbase/docs/en/doc1.html">Getting Started (or other categories)</a><a href="/underbase/docs/en/doc2.html">Guides (or other categories)</a><a href="/underbase/docs/en/doc3.html">API Reference (or other categories)</a></div><div><h5>Community</h5><a href="https://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://discordapp.com/">Project Chat</a><a href="https://twitter.com/" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/underbase/blog">Blog</a><a href="https://github.com/">GitHub</a><a class="github-button" data-icon="octicon-star" data-count-href="/facebook/docusaurus/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section></footer></div></body></html>